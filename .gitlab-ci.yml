image: mcr.microsoft.com/dotnet/core/sdk:3.1

stages:
  - build
  - publish

workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

build and test:
  stage: build
  services:
    - name: mcr.microsoft.com/azure-storage/azurite:latest
      alias: azurite
      command: ["azurite-blob", "--blobHost", "0.0.0.0", "--blobPort", "10000"]
  artifacts:
    paths:
      - TestResults/
      - Packages/
  coverage: '/^\|\s+Total\s+\|\s+\d+\.?\d+%\s+\|\s+(\d+\.?\d+)%\s+\|\s+\d+\.?\d+%\s+\|$/'
  before_script:
    - ". build/prepare.sh"
  script:
    - "dotnet build -c $FLAVOR $BUILD_ARGS"
    - "dotnet test  -c $FLAVOR -v=n $TEST_ARGS"
    - "mkdir Packages/ || true"
    - "cp $(find ./ -name *.*nupkg -print) Packages/"

publish nuget packages:
  stage: publish
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE != "push"'
      when: on_success
    - when: never
  script:
    - "printenv"
    - "dotnet nuget push **/*.nupkg -s https://api.nuget.org/v3/index.json -k $NUGET_API_KEY"
